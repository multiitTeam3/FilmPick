<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}"
      >
<head>
    <title th:text="${title}">Insert title here</title>

    <meta charset="UTF-8">
    <title>Title</title>


    <style>
        .divbtnwrap{
            display: flex;
            justify-content: center;
            padding-top: 50px;
            padding-bottom: 50px;
        }
        .divbtn{
            width: 80%;
        }

        .btnbasket{
            float: right ;
        }
        .selectdiv{
            display: flex;
            height: 40vh;
        }
        .table{
            width: 60%;
        }
        .tablediv{
            display : flex;
        }
        .productdiv{
            width: 15vh;
            height: 20vh;
        }
        .pcount{
            width: 5vh;
        }
        .pimg{
            display:block;
	        width:100%;
	        height:auto;
        }
    </style>
</head>
<body>

<div layout:fragment="content">

    <div class="divbtnwrap">
        <div class="divbtn" id="divbtn"></div>
        <button class="btnbasket" onclick="getbasket()">장바구니</button>
    </div>


    <div>
        <h2>콤보</h2>
        <div class="selectdiv" id="selectdiv">

        </div>
    </div>

    <div class="tablediv">
        <table class="table" id="table">
            <thead>
            <tr>
                <th>
                    상품번호
                </th>
                <th>
                    상품명
                </th>
                <th>
                    가격
                </th>
                <th>
                    수량
                </th>
                <th>
                    삭제
                </th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
        <div id="totaldiv">

            <form action="basket" method="post" id="resultform">
                <input type="number" value="0" id="totalprice" name="totalprice" readonly>

                <button type="submit">확인</button>
            </form>
        </div>
    </div>
</div>
<script>
    $(function (){

        $.ajax({
            url:"/product/category",
            success: function (data){
                const $divbtn = $("#divbtn");

                for(let index in data){
                    var code = data[index].categorycode;
                    $divbtn.append(
                        '<button onclick="findbycategory(' + code + ')">' + data[index].categoryName + '</button>'
                    );
                }
            },
            error: function (xhr){
                console.log(xhr);
            }
        })

        findbycategory(0);




    })

    function findbycategory(category){
        $.ajax({
            url:"/product/productbycategory",
            data: {category : category},
            success: function (data){

            $('#selectdiv').empty();

            for(let index in data){
                var one = JSON.stringify(data[index]);
                $('#selectdiv').append(
                $('<div>').prop({
                    id: data[index].productNo,
                    className: 'productdiv'
                    }).attr("onclick", "addtbody(" + one + ")")
                );
                $('#' + data[index].productNo).append(
                    '<img src="/img/uploadFiles/' + data[index].productImg + '" class="pimg">'
                );
                $('#' + data[index].productNo).append(
                    '<b>' + data[index].name +'</b><br>'
                );
                $('#' + data[index].productNo).append(
                    '<sub>' + data[index].content + '</sub>'
                );
            }

            },
            error: function (xhr){
                console.log(xhr);
            }
        })
    }

    function addtbody(one){
            var p = JSON.stringify(one);
            if ($('#' + one.productNo + 'tbody').length){

            }
            else{
                $('#totaldiv').append(
                    '<input type="hidden" value="' + one.price + '" id = "' + one.productNo + 'total'  + '">'
                );

                $('#table').append(
                $('<tbody>').prop({
                    id: one.productNo + 'tbody'
                })
                );

             $('#' + one.productNo + 'tbody' ).append(
                $('<td>').prop({
                    innerText: one.productNo
                })
             );

             $('#' + one.productNo + 'tbody' ).append(
                $('<td>').prop({
                    innerText: one.name
                })
             );

             $('#' + one.productNo + 'tbody' ).append(
                $('<td>').prop({
                    id: one.productNo + 'tprice'
                })
             );

             $('#' + one.productNo + 'tprice' ).append(
                    '<input type="number" value="' + one.price + '" id = "' + one.productNo + 'price'  + '"readonly>'
             );

              total = Number($('#totalprice').val()) + one.price;

              $('#totalprice').val(total);


             $('#' + one.productNo + 'tbody' ).append(
                $('<td>').prop({
                    id: one.productNo + 'tdnum'
                })
             );

             $('#' + one.productNo + 'tdnum' ).append(
                    '<button onclick="countminus(' + one.productNo + ')">-</button>'
              );

             $('#' + one.productNo + 'tdnum' ).append(
                '<input type="number" class="pcount" value="1" min="1" id = "' + one.productNo + 'count'  + '">'
             );
             $('#' + one.productNo + 'count' ).attr("onChange", "totalchange(" + p + ")");

             $('#' + one.productNo + 'tdnum' ).append(
                    '<button onclick="countplus(' + one.productNo + ')">+</button>'
             );


             $('#' + one.productNo + 'tbody' ).append(
                $('<td>').prop({
                    id: one.productNo + 'tddelete'
                })
             );
             $('#' + one.productNo + 'tddelete' ).append(
                    '<button onclick="deleteproduct(' + one.productNo + ')">삭제</button>'
              );


             count = $('#' + one.productNo + 'count' ).val();

             $('#resultform').append(
                    '<input type="hidden" value="' + one.productNo + '" name = "productnum" id = "' + one.productNo + 'formproduct'  + '">'
             );
             $('#resultform').append(
                    '<input type="hidden" value="' + count + '" name = "productcount" id = "' + one.productNo + 'formcount'  + '">'
             );
            }

    }

    function totalchange(one){
        before = $('#' + one.productNo + 'total' ).val();

        count = $('#' + one.productNo + 'count' ).val();
        $('#' + one.productNo + 'total' ).val(one.price*count);
        $('#' + one.productNo + 'formcount' ).val(count);

        pricechange = one.price*count - before;

        total = Number($('#totalprice').val()) + pricechange;

        $('#totalprice').val(total);
    }

    function countplus(pnum){
        //카운트 변경
        count = Number($('#' + pnum + 'count' ).val());

        count += 1;

        $('#' + pnum + 'formcount' ).val(count);
        $('#' + pnum + 'count' ).val(count);

        //총 가격 변경
        price = Number($('#' + pnum + 'price' ).val());
        total = Number($('#totalprice').val());

        $('#totalprice').val(total + price);
    }

    function countminus(pnum){
        //카운트 변경
        count = Number($('#' + pnum + 'count' ).val());

        count -= 1;

        $('#' + pnum + 'formcount' ).val(count);
        $('#' + pnum + 'count' ).val(count);

        //총 가격 변경
        price = Number($('#' + pnum + 'price' ).val());
        total = Number($('#totalprice').val());

        $('#totalprice').val(total - price);
    }

    function getbasket(){
        $.ajax({
            url:"/product/getbasket",
            success: function (data){
                var productList = data.productList;
                var productQuantityList = data.productQuantityList;

                for(let index in productList){
                    addtbody(productList[index]);

                    $('#' + productList[index].productNo + 'count' ).val(productQuantityList[index]);
                    $('#' + productList[index].productNo + 'formcount' ).val(productQuantityList[index]);
                }

                $('#totalprice').val(data.totalprice);

            },
            error: function (xhr){
                console.log(xhr);
            }
        })
    }

    function deleteproduct(pnum){
        $('#' + pnum + 'tbody' ).remove();

        $('#' + pnum + 'formproduct' ).remove();
        $('#' + pnum + 'formcount' ).remove();

        $('#' + pnum + 'total' ).remove();
    }


</script>
</body>
</html>