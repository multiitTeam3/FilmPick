<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      layout:decorate="~{layoutAdmin}">
<head>
    <title>Movie Manage Page</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/container-box.css}">
    <link rel="stylesheet" th:href="@{/css/movieManage.css}">

    <style>
        .pageNums1, .pageNums2 {
            text-align: center;
        }


    </style>
    <script type="text/javascript">

        $(document).ready(
           function(){

               // 테이블 자료 이용함
               function findEnrolledList(page){

                   $('#list').html("");

                   $.ajax({

                       url: '/admin/movie/findAllEnrolledMovie?page=' + page,
                       method: 'POST',
                       contentType: 'application/json',
                       success: function(responseDTO){

                           var list = responseDTO.list;
                           var pages = responseDTO.pages;
                           var count = responseDTO.count;

                           $('#list').html("");

                           $.each(list, function(index, movie){

                                var adultContent = movie.adult ==0? "해당없음" : "성인영화";

                                var lessContent = movie.movieContent.length > 20?
                                movie.movieContent.substring(0,30) + "....."
                                : movie.movieContent;

                                var index1 = (index +1) + (page-1)*3;

                                var htmlContent = `

                                    <tr>
                                        <th scope="row">${index1}</th>
                                        <td id="movieNo">${movie.movieNo}</td>
                                        <td id="movieTitle">${movie.movieTitle}</td>
                                        <td id="genreContent">${movie.genreContent}</td>
                                        <td id="popularity">${movie.popularity}</td>
                                        <td id="duration">${movie.duration}</td>
                                        <td id="movieContent">${lessContent}</td>
                                        <td id="adult">${adultContent}</td>
                                        <td id="image"><img src="${movie.posterPath}"
                                                            width="40px"></td>
                                        <td id="avgRate">${movie.avgRate}</td>
                                        <td id="ticketSold">${movie.ticketSold}</td>


                                    </tr>

                                `;

                                $('#list').append(htmlContent);

                           })

                           $('.pageNums1').html("");

                             for(var p=1; p<=pages; p++){
                                $('.pageNums1').append('<button class="pages1">'+ p  + '</button>');
                             }

                       }

                   })

               }


                findEnrolledList(1);

                $(document).on('click','.pages1',function(){
                     const page = $(this).text();
                     findEnrolledList(page);
                })


                // api 이용
               function findAPIMovieList(page){

                   $('#list2').html("");

                   $.ajax({

                       url: '/admin/movie/findAPIMovieList?page=' + page,
                       method: 'POST',
                       contentType: 'application/json',
                       success: function(list){


                           $.each(list, function(index, movie){

                                var adultContent = movie.adult ==0? "해당없음" : "성인영화";

                                var lessContent = movie.movieContent.length > 20?
                                movie.movieContent.substring(0,30) + "....."
                                : movie.movieContent;
                                console.log("movieId : " + movie.id)

                                var index1 = (index +1) + (page-1)*20;

                                var htmlContent = `

                                    <tr>

                                        <th scope="row">${index1}</th>
                                        <td id="movieTitle">${movie.movieTitle}</td>
                                        <td id="genreNo">${movie.genreNo}</td>
                                        <td id="popularity">${movie.popularity}</td>
                                        <td id="duration">${movie.duration}</td>
                                        <td id="movieContent">${lessContent}</td>
                                        <td id="adult">${adultContent}</td>
                                        <td id="image"><img src="${movie.posterPath}"
                                                            width="40px"></td>
                                        <td id="insertBtn">
                                         <button id="insertMovie" val="${movie.id}">추가</button>
                                         </td>

                                    </tr>

                                `;

                                $('#list2').append(htmlContent);


                           })

                       }

                   })

               }


                findAPIMovieList(1);


                 for(var p=1; p<=10; p++){
                    $('.pageNums2').append('<button class="pages2">'+ p  + '</button>');
                 }


                $(document).on('click','.pages2',function(){
                     const page = $(this).text();
                     findAPIMovieList(page);

                })


                $(document).on('click','#insertMovie',function(){
                     var movieId = $(this).attr('val');
                     console.log("click movieId : "+movieId)
                     var button = $(this);

                      $.ajax({

                           url: '/admin/movie/insertAPIMovie?id=' + movieId,
                           method: 'POST',
                           contentType: 'application/json',
                           success: function(response){
                                alert(response);
                                button.text("영화추가 완료");
                                button.addClass('unclickable');
                                button.prop('disabled',true);
                                findAPIMovieList(1);
                           }

                      })

                })


                // 장르 삽입
                $(document).on('click','#insertGenre',function(){

                    var button = $(this);

                     $.ajax({

                       url: '/admin/movie/insertGenre',
                       method: 'POST',
                       contentType: 'application/json',
                       success: function(response){
                            console.log(response);
                            button.text("장르추가 완료");
                            button.addClass('unclickable');
                            button.prop('disabled',true);
                       }

                     })



                })

           }
        )





    </script>

</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <div class="text-center my-4">
            <h1>관리자 페이지</h1>
        </div>

        <div class="top">
            <div class="container-box">
                <h2>영화 관리</h2>
                <div class="content" id="enrolled-Movie-List">
                    <br>
                    <h1>등록된 영화 리스트</h1><br>
                    <table class="table table-striped">
                        <thead class="table-dark">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">영화번호</th>
                            <th scope="col">영화제목</th>
                            <th scope="col">장르이름</th>
                            <th scope="col">유명도</th>
                            <th scope="col">상영시간(시)</th>
                            <th scope="col">영화내용</th>
                            <th scope="col">성인영화</th>
                            <th scope="col">포스터보기</th>
                            <th scope="col">평균평점</th>
                            <th scope="col">티켓판매량(수량)</th>
                        </tr>
                        </thead>
                        <tbody id="list"></tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-center mt-3">
                    <div class="pageNums1"></div>
                </div>
            </div>
        </div>

        <div class="bottom">
            <div class="container-box">
                <div class="content" id="add-Movie">
                    <h1>DB에 영화 추가
                        <button id="insertGenre" class="btn btn-link">장르추가</button>
                    </h1>
                    <br>
                    <table class="table table-striped">
                        <thead class="table-dark">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">영화제목</th>
                            <th scope="col">장르이름</th>
                            <th scope="col">유명도</th>
                            <th scope="col">상영시간(시)</th>
                            <th scope="col">영화내용</th>
                            <th scope="col">성인영화</th>
                            <th scope="col">포스터</th>
                            <th scope="col">영화추가</th>
                        </tr>
                        </thead>
                        <tbody id="list2"></tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-center mt-3">
                    <div class="pageNums2"></div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>