<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
      layout:decorate="~{layout.html}">
<head>
    <title>Home Page</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


    <style>

        .above{

            display: flex;
            flex-flow: row;
            align-items: center;
            justify-content: center
            margin: 15%;


        }


        .left{

            display: flex;
            flex-flow: column;
            align-items: center;
            justify-content: center
            margin: 5%;
            width: 40%;

        }


        .right{
            width: 100%;
            height: 100%;
            display: flex;
            flex-flow: column;
            align-items: space-between;
            justify-content: space-between;
            margin: 5%;

        }

        textarea{

            background-color: white;
            width: 500px;
            height: 40px;

        }

        button:hover{
            background-color: #6482B9;
            color: white;

        }


        .right div .list{

            margin-bottom: 10%;

        }

        table, th, td{
            border: 1px solid black;
        }


        th, td{
            width: 300px;

        }

        td #content{
            width: 800px;
        }

        img{
            margin: 10%;
        }


    </style>

    <script th:inline="javascript">

        var movieNo = "[[${movieNo}]]";
        console.log("movieNo : " + movieNo)


        $(document).ready(
            function(){

                function findVWReviewListByMovieNo(movieNo, page){

                    $('.data').html("");
                    $('.left').html("");

                    $.ajax({

                        url: '/movie/VWReviewListByMovieNo?page='+page+'&movieNo='+movieNo,
                        method: 'POST',
                        contentType: 'application/json',
                        success: function(response){

                            var list = response.reviews;
                            var pages = response.pages;
                            var count = response.count;

                            let imageAppended=false;

                            const perPage = 3;
                            const startIndex = (page-1)*perPage;

                            $.each(list, function(index, review){


                                if(!imageAppended){

                                    const image = `
                                    <img src="${review.posterPath}">

                                    `;

                                    $('.left').append(image);

                                    imageAppended=true;

                                }

                                const listNum = startIndex + index + 1;

                                var htmlContent = `

                                    <tr>
                                        <td id="no">${listNum}</td>
                                        <td id="movieTitle">${review.movieTitle}</td>
                                        <td id="memberName">${review.userName}</td>
                                        <td id="content">${review.content}</td>
                                        <td id="rate">${review.rate}</td>
                                        <td id="date">${review.createDate}</td>
                                    </tr>

                                    <hr>

                                `;

                                $('.data').append(htmlContent);

                            })


                            $('.pageNums').html("");

                             for(var p=1; p<=pages; p++){
                                $('.pageNums').append('<button class="pages">'+ p  + '</button>');
                             }



                        }
                    })
                }


                findVWReviewListByMovieNo(movieNo, 1);


                $(document).on('click','.pages',function(){
                     const page = $(this).text();
                     findVWReviewListByMovieNo(movieNo, page);

                })


                $(document).on('click','.insertBtn',function(){
                     const inputRate = $('#inputRate').val();
                     const textArea = $('#textArea').val();


                    $.ajax({

                        url: '/movie/insertReview',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            movieNo: movieNo,
                            rate: inputRate,
                            content: textArea

                        }),

                        success: function(response){
                            console.log("success : " + response);

                            $('#inputRate').val('');
                            $('#textArea').val('');

                            findVWReviewListByMovieNo(movieNo, 1);

                        }
                    })




                })


            }
        )


    </script>


</head>
<body>

<div layout:fragment="content">


    <div class="above">


        <div class="left">

            <img src="http://image.tmdb.org/t/p/w500//pmemGuhr450DK8GiTT44mgwWCP7.jpg">


        </div>

        <div class="right">

            <div class="list">

                <table>

                    <thead>

                        <tr>

                            <th>번호</th>
                            <th>영화 이름</th>
                            <th>회원 이름</th>
                            <th>내용</th>
                            <th>평점</th>
                            <th>작성일</th>

                            <hr>

                        </tr>


                    </thead>

                    <tbody class="data">

                    </tbody>




                </table>


            </div>

            <div class="pageNums"></div>

            <br><br><br><br><br><br><br>

            <div class="inputText">
                <h3>감상평 작성</h3>


                별점 입력 : <input type="number" min="0.0" max="5.0" id="inputRate"><br><br>
                <textarea id="textArea"></textarea><br><br>

                <button class="insertBtn">제출하기</button>


            </div>


        </div>


    </div>


</div>


<script>


</script>


</body>
</html>