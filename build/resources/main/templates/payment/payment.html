<!DOCTYPE html>
<html layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>결제 페이지</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
<div layout:fragment="content">
    <div class="container">
        <div class="row">
            <div class="col-md-12 p-4">
                <h2 class="font-weight-bold mb-4">결제 정보</h2>
                <div th:if="${reservations != null && !reservations.isEmpty()}">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <img th:src="@{${reservations[0].posterPath}}" alt="Movie Poster" class="img-fluid rounded">
                        </div>
                        <div class="col-md-4">
                            <h2 class="font-weight-bold mb-4">영화정보</h2>
                            <p><strong>영화명:</strong> <span th:text="${reservations[0].movieTitle}"></span></p>
                            <p><strong>일시:</strong> <span th:text="${reservations[0].date}"></span></p>
                            <p><strong>상영 시간:</strong> <span th:text="${reservations[0].startTime} + ' - ' + ${reservations[0].endTime}"></span></p>
                            <p><strong>영화관:</strong> <span th:text="${reservations[0].cinemaName}"></span></p>
                            <p><strong>상영관:</strong> <span th:text="${reservations[0].screenName}"></span></p>
                            <p><strong>좌석:</strong>
                                <span th:text="${seatNames}"></span>
                            </p>
                            <p><strong>인원:</strong> 성인 <span th:text="${adultCount}"></span>명 청소년 <span th:text="${teenCount}"></span>명</p>
                        </div>
                    </div>
                </div>
                <span>결제방식 선택</span>
                <button class="btn btn-secondary btn-block mb-2" id="kakao">카카오 페이</button>
                <button class="btn btn-secondary btn-block mb-2" id="card">카드 결제</button>
                <button class="btn btn-secondary btn-block mb-2" id="nobank">무통장 입금</button>
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span>상품금액</span>
                    </div>
                    <div th:if="${reservations != null && !reservations.isEmpty()}">
                        <span th:text="${totalPrice}"></span> 원
                    </div>
                    <form method="post" th:action="@{/payment/kakaoPay}">
                        <input type="hidden" id="reservations" th:value="${reservationsJson}" />
                        <input type="hidden" id="totalPrice" th:value="${totalPrice}" />
                        <input type="hidden" id="adultCount" th:value="${adultCount}" />
                        <input type="hidden" id="teenCount" th:value="${teenCount}" />
                        <button type="submit">결제하기</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function() {
        // '결제하기' 버튼을 클릭했을 때
        $('#kakao').click(function(e) {
            e.preventDefault();

            // 숨겨진 필드에서 데이터 가져오기
            var reservationsData = $('#reservations').val();
            var parsedReservations = JSON.parse(reservationsData);

            $.ajax({
                url: '/payment/kakaoPay',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(parsedReservations),
                success: function(response) { // 요청 성공 시 수행할 함수
                    console.log('Payment successful:', response);
                    alert(response.next_redirect_pc_url);
                    window.location.href= response.next_redirect_pc_url;
                },
                error: function(xhr, status, error) { // 요청 실패 시 수행할 함수
                    console.error('Payment failed:', error);
                    alert('결제에 실패했습니다.');
                }
            });
        });
    });
</script>
</body>
</html>